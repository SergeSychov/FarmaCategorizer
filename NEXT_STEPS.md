# Следующие шаги для доработки обработчика

## 1. Улучшение качества классификации

### 1.1 Ошибка «торговое название → МНН»
**Проблема**: Ниаспам (МНН мебеверин) — модель восприняла торговое название как МНН.

**Варианты**:
- Добавить в промпт правило: «торговое название ≠ МНН; при незнакомом названии ищи в справочниках».
- Few-shot пример: `Ниаспам → мебеверин` в `prompt_builder`.
- Справочник торговое название → МНН (таблица/файл) для постобработки или подсказки в промпте.

### 1.2 Уточнение внутри МНН-кластера
**Проблема**: Ремантадин A15_01 vs A15_02 — модель не различает подкатегории.

**Варианты**:
- Дополнить `inn_cluster` в дереве категорий (комментарии, подписи к *_01, *_02).
- Few-shot примеры с явным выбором между A15_01 и A15_02 по признакам (форма, возраст и т.п.).

---

## 2. Масштабирование и производительность

### 2.1 Параллельные запросы
- Сейчас `evaluate_on_testset` и `run_batch_classification` идут последовательно.
- Добавить `asyncio.Semaphore` и `asyncio.gather` с ограничением (например, 3–5 параллельных запросов к API).
- Сократить время прогона на больших выборках.

### 2.2 Пакетная обработка в API
- Если провайдер поддерживает batch-запросы — отправлять несколько SKU одним вызовом.
- Снижение числа HTTP-запросов и стоимости.

---

## 3. Оценка и отладка

### 3.1 Расширение тестовой выборки
- Сейчас `limit=10`. Добавить аргумент CLI: `--limit N` или `--all`.
- Прогон по всему TestButch для стабильной оценки.

### 3.2 Метрики и анализ ошибок
- Confusion matrix по кодам категорий.
- Precision/recall/F1 по категориям или по группам.
- Сохранение отчёта (JSON/CSV) с результатами для разбора.

### 3.3 Кэширование ответов LLM
- Сохранять `raw_llm_response` в файл (JSON) при первом прогоне.
- Опция `--use-cache`: читать из кэша вместо повторных вызовов API.
- Ускоряет отладку и делает оценки воспроизводимыми.

---

## 4. Конфигурация и эксплуатация

### 4.1 Аргументы командной строки
- `evaluate_on_testset`: `--limit`, `--testset PATH`, `--output PATH`.
- `run_batch_classification`: `--limit`, `--dry-run`.
- Скрипт загрузки категорий: `--xlsx PATH`, `--sheet NAME`.

### 4.2 Логирование
- Структурированные логи (JSON) с `sku_name`, `category_code`, `confidence`, `duration`.
- Уровень логирования через конфиг или env.

### 4.3 Тесты
- Интеграционный тест: загрузка категорий → классификация одного SKU.
- Тест на `load_testset` с реальным (или мок-) xlsx.

---

## 5. Приоритеты

| # | Задача | Сложность | Эффект |
|---|--------|-----------|--------|
| 1 | Few-shot пример Ниаспам/мебеверин | Низкая | Снижение путаницы торговое название ↔ МНН |
| 2 | CLI-аргументы для evaluate и run_batch | Низкая | Удобство использования |
| 3 | Параллельные запросы (Semaphore) | Средняя | Быстрее прогоны |
| 4 | Кэширование ответов LLM | Средняя | Воспроизводимость, скорость отладки |
| 5 | Confusion matrix / отчёт по ошибкам | Средняя | Анализ слабых мест |
| 6 | Справочник торговое название → МНН | Высокая | Повышение точности по МНН |
