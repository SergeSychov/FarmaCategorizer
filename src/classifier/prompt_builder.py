# src/classifier/prompt_builder.py
from __future__ import annotations

from dataclasses import dataclass
from typing import List

from src.data_models import SKU, Category


PROMPT_SYSTEM_INSTRUCTIONS = """
Ты — эксперт по фармацевтическим препаратам и аптечным товарам.

Твоя задача:
1) По названию товара (SKU) найти информацию о препарате в открытых источниках (интернет).
2) Убедиться, что найденное описание соответствует этому SKU (форма выпуска, дозировка, бренд, возраст, путь введения и др.).
3) Извлечь:
   - МНН / действующее вещество;
   - фармакологическую группу;
   - лекарственную форму;
   - возрастные ограничения;
   - OTC или Rx (если явно указано).
4) На основании предоставленного дерева категорий выбрать ОДНУ наиболее подходящую категорию.
5) Если информации недостаточно или совпадения неоднозначные — понижать уверенность и помечать результат как needs_review = true.
6) НЕ выдумывать данные, которых нет в достоверных источниках. Лучше честно указать, что данных недостаточно.

Критически важные правила выбора категории:

7) Сначала ОПРЕДЕЛИ МНН (действующее вещество) препарата. Если МНН не удаётся определить надёжно, сразу понизь confidence и установи needs_review = true.

7a) Учитывай, что МНН и названия действующих веществ могут быть написаны как кириллицей, так и латиницей
    (например, «суматриптан» и «Sumatriptan», «пантопразол» и «Pantoprazole» — это одно и то же вещество). Например "Римантадин":
    - только кириллицей («римантадин»),
    - только латиницей («Rimantadine»),
    - или в комбинированном виде с разделителем («Римантадин/Rimantadine»).
    Ты обязан:
    - приводить найденное МНН к единому виду (распознавать одинаковые вещества при разных вариантах написания);
    - при поиске по полю «МНН‑кластер» учитывать обе записи: если в кластере указано «Sumatriptan», а в описании препарата найдено «суматриптан», это считается точным совпадением МНН (и наоборот);
    - не считать такие различия основанием для выбора другой категории или для игнорирования подходящего МНН‑кластера.

8) В дереве категорий ищи СНАЧАЛА строки, где поле «МНН‑кластер» ЯВНО соответствует найденному МНН или его точному синониму
   (например, «Эналаприл», «Лизиноприл», «Валацикловир», «Урсодезоксихолевая кислота», фразы вида «все дозировки <МНН>»).

9) Если в дереве есть одна или несколько категорий с подходящим «МНН‑кластером», ты ОБЯЗАН:
   - выбирать категорию ТОЛЬКО из этого поднабора строк;
   - отдавать приоритет точному совпадению МНН в «МНН‑кластере»;
   - НЕ использовать категории, где «МНН‑кластер» содержит другое действующее вещество, даже если описание похоже.

10) Запрещено выбирать категорию, где в «МНН‑кластере» указано другое вещество
    (например, не относить лизиноприл к кластеру эналаприла, валацикловир к ацикловиру и т.п.), даже если остальные поля похожи.

11) Только если в дереве ВООБЩЕ НЕТ категории с подходящим «МНН‑кластером», используй более общие признаки
    (направление, потребность/нозология, возраст, способ введения и т.п.) и обязательно понижай confidence, при необходимости ставь needs_review = true.

Специальные правила для категорий внутри одного МНН‑кластера:

12) Для МНН, у которых в дереве несколько очень похожих категорий (разные «хвосты» кодов типа *_01, *_02 внутри одного МНН‑кластера),
    ты ДОЛЖЕН:
    - сравнить форму выпуска, путь применения, показания, возраст, Rx/OTC и другие детали из описания препарата;
    - выбирать код только тогда, когда признаки ЯВНО соответствуют описанию конкретной строки классификатора;
    - если по SKU и описанию НЕДОСТАТОЧНО данных, чтобы надёжно различить, например, LS_ORVI_MNN_A39_01 и LS_ORVI_MNN_A39_02
      (или аналогичные пары/группы внутри кластера), ты обязан:
        * НЕ угадывать;
        * установить needs_review = true;
        * выбрать умеренный confidence (например, 0.5–0.6, но не выше 0.8);
        * в поле reason явно перечислить рассматриваемые коды (например, «A39_01 и A39_02») и объяснить, чего не хватает для уверенного выбора.
12b) Если для найденного МНН в дереве категорий есть несколько строк в одном МНН-кластере
     (например, коды отличаются только хвостом *_01, *_02, *_03), по умолчанию:
     - считай, что различия между ними основаны на тонких клинических нюансах, которые часто НЕ видны из названия SKU;
     - тебе запрещено выбирать один из таких кодов с высокой уверенностью, если нет явного признака в описании.

     В типичной ситуации:
     - если ты рассматриваешь более одного кода внутри одного МНН-кластера и не видишь в описании препарата чётких указаний
       на конкретную строку, ты обязан:
         * установить needs_review = true,
         * выставить confidence не выше 0.6,
         * в reason указать, какие коды рассматривались (например, LS_ORVI_MNN_A15_01 и LS_ORVI_MNN_A15_02).
         
13) Если ты уверен менее чем на ~80 % при выборе между несколькими категориями внутри одного и того же МНН‑кластера,
    всегда:
    - устанавливай needs_review = true;
    - выставляй confidence не выше 0.6;
    - объясняй в reason, почему выбор неоднозначен.

14) Если, наоборот, есть чёткое совпадение МНН, формы, показаний и возрастной группы с конкретной строкой МНН‑кластера,
    ты МОЖЕШЬ:
    - установить needs_review = false;
    - выставить более высокий confidence (например, 0.8–0.95);
    - в reason явно сослаться на совпадение с конкретной строкой «МНН‑кластера» (название вещества, форма, показания).

Формат ответа:

15) Всегда возвращай ровно один JSON‑объект строго заданной структуры, БЕЗ какого‑либо текста вокруг.
16) Структура JSON и имена полей должны ТОЧНО соответствовать шаблону, который тебе передан отдельно (не добавляй новые поля, не меняй типы).
17) В поле reason кратко опиши ход рассуждений: как найдено МНН, какие строки «МНН‑кластера» ты сравнивал, почему выбран именно этот код,
    и почему (или почему не) установлен needs_review.
""".strip()


PROMPT_OUTPUT_FORMAT = r"""
Верни ОДИН объект JSON СТРОГО следующей структуры (без комментариев и текста вокруг):

{
  "inn": string или null,
  "dosage_form": string или null,
  "age_restriction": string или null,
  "otc": true или false или null,
  "category_code": string или null,
  "category_path": string или null,
  "confidence": number от 0 до 1,
  "needs_review_hint": true или false,
  "reason": string
}

Никакого текста до или после JSON, никаких пояснений вне полей объекта.
""".strip()


FEW_SHOT_EXAMPLES = """
Примеры разбора SKU и выбора категории.
Во всех примерах структура JSON-ответа строго совпадает с требуемой схемой.

=== ПРИМЕР 1 ===
SKU:
ВАЛТРЕКС ТАБЛ. П/ПЛЕН/ОБ. 500МГ №10

Ожидаемый JSON-ответ:
{
  "inn": "валацикловир",
  "dosage_form": "таблетки, покрытые пленочной оболочкой",
  "age_restriction": "взрослые",
  "otc": false,
  "category_code": "LS_ORVI_MNN_A39_02",
  "category_path": null,
  "confidence": 0.9,
  "needs_review_hint": false,
  "reason": "По названию SKU и найденному описанию определён препарат Валтрекс (МНН валацикловир) в форме таблеток 500 мг для взрослых, системное противогерпетическое средство. В дереве категорий выбран код LS_ORVI_MNN_A39_02, так как в МНН-кластере 'Валацикловир' эта строка явно описывает таблетки валацикловира 500 мг для системного лечения герпесвирусных инфекций у взрослых. Другие коды кластера не соответствуют форме и назначению данного SKU."
}

=== ПРИМЕР 2 ===
SKU:
ВАЛАЦИКЛОВИР ТАБЛ. П/ПЛЕН/ОБ. 500МГ №10

Ожидаемый JSON-ответ:
{
  "inn": "валацикловир",
  "dosage_form": "таблетки, покрытые пленочной оболочкой",
  "age_restriction": "взрослые",
  "otc": false,
  "category_code": "LS_ORVI_MNN_A39_02",
  "category_path": null,
  "confidence": 0.6,
  "needs_review_hint": true,
  "reason": "Определён МНН валацикловир, таблетки 500 мг для взрослых, системное противогерпетическое средство. В МНН-кластере 'Валацикловир' есть несколько возможных кодов (например, LS_ORVI_MNN_A39_01 и LS_ORVI_MNN_A39_02), различающихся по тонким клиническим нюансам. По названию SKU и краткому описанию в открытых источниках нельзя надёжно отличить эти подгруппы, поэтому выбран наиболее типичный код LS_ORVI_MNN_A39_02, но решение требует проверки, установлены needs_review_hint = true и умеренная уверенность."
}

=== ПРИМЕР 3 ===
SKU:
УРСОДЕЗ КАПС. 500МГ №30

Ожидаемый JSON-ответ:
{
  "inn": "урсодезоксихолевая кислота",
  "dosage_form": "капсулы",
  "age_restriction": "взрослые",
  "otc": false,
  "category_code": "LS_GIT_MNN_C22_02",
  "category_path": null,
  "confidence": 0.9,
  "needs_review_hint": false,
  "reason": "По SKU определён препарат Урсодез (урсодезоксихолевая кислота) в капсулах 500 мг для взрослых, гепатопротектор и холеретик при заболеваниях печени и желчевыводящих путей. В МНН-кластере 'Урсодезоксихолевая кислота' несколько строк, но код LS_GIT_MNN_C22_02 соответствует капсулам урсодезоксихолевой кислоты для взрослых; другие строки кластера описывают отличающиеся формы/подгруппы, поэтому выбран C22_02 без необходимости ревью."
}

=== ПРИМЕР 4 ===
SKU:
ПАНТОПРАЗОЛ ТАБЛ. КИШ-РАСТ. П/ПЛЕН/ОБ. 20МГ №28 ИНТЕРФАРМА

Ожидаемый JSON-ответ:
{
  "inn": "пантопразол",
  "dosage_form": "таблетки кишечнорастворимые, покрытые пленочной оболочкой",
  "age_restriction": "взрослые",
  "otc": false,
  "category_code": "LS_GIT_MNN_C03_02",
  "category_path": null,
  "confidence": 0.9,
  "needs_review_hint": false,
  "reason": "Найден препарат пантопразол в форме кишечнорастворимых таблеток 20 мг для взрослых, ингибитор протонной помпы для лечения заболеваний ЖКТ. В МНН-кластере 'Пантопразол' код LS_GIT_MNN_C03_02 описывает такие препараты; другие коды кластера относятся к отличающимся подгруппам, поэтому выбран C03_02 как наиболее точное соответствие без необходимости ревью."
}
=== ПРИМЕР 5 ===
SKU:
СУМАТРИПТАН КАНОН ТАБЛ. П/ПЛЕН/ОБ. 100МГ №2

Ожидаемый JSON-ответ:
{
  "inn": "суматриптан",
  "dosage_form": "таблетки, покрытые пленочной оболочкой",
  "age_restriction": "взрослые",
  "otc": false,
  "category_code": "LS_PAIN_MNN_F03_01",
  "category_path": null,
  "confidence": 0.9,
  "needs_review_hint": false,
  "reason": "По названию SKU и описанию в открытых источниках определён препарат Суматриптан Канон (МНН суматриптан) в форме таблеток 100 мг для взрослых, триптан для купирования приступов мигрени. В МНН-кластере 'Препараты при мигрени триптаны взрослые внутрь' несколько кодов, но для стандартного суматриптана в таблетках для взрослых по умолчанию используется код LS_PAIN_MNN_F03_01, поэтому выбран именно он."
}
""".strip()


@dataclass
class PromptBuilder:
    """
    Строитель промпта для классификации одного SKU.
    """

    def build_categories_block(self, categories: List[Category]) -> str:
        """
        Формирует текстовый блок со списком категорий.

        Для каждой категории показываем:
        - код;
        - человекочитаемый путь (направление / потребность / категория);
        - МНН-кластер (ключевое поле для выбора по действующему веществу).
        """
        lines = ["Дерево категорий (code — путь и МНН-кластер):"]
        for cat in categories:
            path_parts = [p for p in [cat.direction, cat.need, cat.group] if p]
            path_str = " ".join(path_parts) if path_parts else cat.code

            # Добавляем явное упоминание МНН-кластера
            if cat.inn_cluster:
                path_str += f" | МНН-кластер: {cat.inn_cluster}"

            lines.append(f"- {cat.code}: {path_str}")
        return "\n".join(lines)

    def build_user_prompt(self, sku: SKU, categories: List[Category]) -> str:
        """
        Основной текст запроса (user message) к модели.
        """
        categories_block = self.build_categories_block(categories)

        prompt = f"""
Товар (SKU): "{sku.name}"

Сначала внимательно изучи дерево категорий и используй поле «МНН-кластер» для выбора.

{categories_block}

Структура JSON-ответа, который ты ДОЛЖЕН вернуть:
{PROMPT_OUTPUT_FORMAT}

Примеры правильного разбора SKU и выбора категории (few-shot):

{FEW_SHOT_EXAMPLES}

Теперь обработай следующий SKU по тем же правилам и верни только один JSON-объект указанной структуры (без текста вокруг):

SKU:
{sku.name}
""".strip()

        return prompt
